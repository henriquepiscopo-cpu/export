Option Explicit

Sub AtualizarTabela_VarIPCA_Top10Bottom10()

    Const SHEET_NAME As String = "Var. IPCA"
    Const COL_REF As String = "I"
    Const FIRST_DATA_ROW As Long = 11
    Const TOP_N As Long = 10
    Const BOTTOM_N As Long = 10

    Dim ws As Worksheet
    Dim lastRow As Long, lastCol As Long
    Dim rngSort As Range
    Dim i As Long
    Dim v As Variant

    Dim numericRows() As Long
    Dim nCount As Long

    Set ws = ThisWorkbook.Worksheets(SHEET_NAME)

    Application.ScreenUpdating = False
    Application.EnableEvents = False
    Application.Calculation = xlCalculationManual
    On Error GoTo CleanFail

    ' 1) Reset ocultações
    ws.Rows.Hidden = False

    ' 2) Oculta linhas fixas
    ws.Rows(9).Hidden = True
    ws.Rows(10).Hidden = True

    ' 3) Última linha relevante pela coluna I
    lastRow = ws.Cells(ws.Rows.Count, COL_REF).End(xlUp).Row
    If lastRow < FIRST_DATA_ROW Then GoTo CleanExit

    ' 4) Última coluna usada na linha 11 (fallback para I)
    lastCol = ws.Cells(FIRST_DATA_ROW, ws.Columns.Count).End(xlToLeft).Column
    If lastCol < 9 Then lastCol = 9

    ' 5) Range para ordenar (A até lastCol)
    Set rngSort = ws.Range(ws.Cells(FIRST_DATA_ROW, 1), ws.Cells(lastRow, lastCol))

    ' 6) Ordena pela coluna I (sem cabeçalho)
    With ws.Sort
        .SortFields.Clear
        .SortFields.Add Key:=ws.Range(ws.Cells(FIRST_DATA_ROW, COL_REF), ws.Cells(lastRow, COL_REF)), _
                        SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:=xlSortNormal
        .SetRange rngSort
        .Header = xlNo
        .MatchCase = False
        .Orientation = xlTopToBottom
        .Apply
    End With

    ' 7) Primeiro oculta todo mundo no bloco (depois reexibe o que interessa)
    ws.Rows(FIRST_DATA_ROW & ":" & lastRow).Hidden = True

    ' 8) Coleta linhas numéricas e já garante que erros (#N/D etc) ficam ocultos
    ReDim numericRows(1 To (lastRow - FIRST_DATA_ROW + 1))
    nCount = 0

    For i = FIRST_DATA_ROW To lastRow
        v = ws.Cells(i, COL_REF).Value

        ' Se for erro (#N/D etc), continua oculto
        If IsError(v) Then
            ' opcional: se quiser esconder só #N/D e deixar outros, dá pra checar o tipo do erro
            ' mantém oculto
        ElseIf IsNumeric(v) And Len(CStr(v)) > 0 Then
            nCount = nCount + 1
            numericRows(nCount) = i
        Else
            ' texto/vazio -> continua oculto
        End If
    Next i

    If nCount = 0 Then GoTo CleanExit

    ' 9) Reexibe Top 10 e Bottom 10 (somente numéricos)
    Dim topLimit As Long, bottomStartIdx As Long
    topLimit = WorksheetFunction.Min(TOP_N, nCount)
    bottomStartIdx = WorksheetFunction.Max(1, nCount - BOTTOM_N + 1)

    ' Top 10 (menores)
    For i = 1 To topLimit
        ws.Rows(numericRows(i)).Hidden = False
    Next i

    ' Bottom 10 (maiores)
    For i = bottomStartIdx To nCount
        ws.Rows(numericRows(i)).Hidden = False
    Next i

CleanExit:
    Application.ScreenUpdating = True
    Application.EnableEvents = True
    Application.Calculation = xlCalculationAutomatic
    Exit Sub

CleanFail:
    Application.ScreenUpdating = True
    Application.EnableEvents = True
    Application.Calculation = xlCalculationAutomatic
    MsgBox "Erro na macro: " & Err.Number & " - " & Err.Description, vbExclamation
End Sub
