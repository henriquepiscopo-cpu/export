Option Explicit

Sub CopiarUltimaLinhaVolume_Para_Deb_CRICRA()

    Dim wsOrigem As Worksheet, wsPrazo As Worksheet, wsEnc As Worksheet
    Dim wsPrazo12431 As Worksheet, wsOferDetNInc As Worksheet, wsOferDet As Worksheet
    Dim wsDestRec As Worksheet, wsDestino As Worksheet

    Dim lastRowOrigem As Long, lastRowPrazo As Long, lastRowEnc As Long
    Dim lastRowPrazo12431 As Long, lastRowOferDetNInc As Long, lastRowOferDet As Long, lastRowDestRec As Long

    Dim nextRowB As Long, nextRowQ As Long, nextRowS As Long, targetRow As Long
    Dim c As Long

    Dim prazoValor As Variant, prazo12431Valor As Variant
    Dim arrVol As Variant, arrEnc As Variant, arrOferNInc As Variant, arrOfer As Variant, arrDestRec As Variant

    Dim oldCalc As XlCalculation, oldEvents As Boolean, oldScreen As Boolean
    Dim passo As Long

    On Error GoTo EH
    passo = 0

    ' ===== Performance =====
    oldCalc = Application.Calculation
    oldEvents = Application.EnableEvents
    oldScreen = Application.ScreenUpdating

    Application.ScreenUpdating = False
    Application.EnableEvents = False
    Application.Calculation = xlCalculationManual

    passo = 1

    ' ===== Abas =====
    Set wsOrigem = ThisWorkbook.Worksheets("Volume")
    Set wsDestino = ThisWorkbook.Worksheets("Deb, CRICRA FII Fiagro (Mensal)")
    Set wsPrazo = ThisWorkbook.Worksheets("Prazo Médio não Inc")
    Set wsEnc = ThisWorkbook.Worksheets("12 431 V  Encerrados")
    Set wsPrazo12431 = ThisWorkbook.Worksheets("12 431 Prazo Médio")
    Set wsOferDetNInc = ThisWorkbook.Worksheets("Ofer  Detentor N Inc")
    Set wsOferDet = ThisWorkbook.Worksheets("12 431 Ofer  Detentor")
    Set wsDestRec = ThisWorkbook.Worksheets("Dest  Recursos")

    passo = 2

    ' garante cálculo (para .Text)
    wsOrigem.Calculate
    wsEnc.Calculate
    wsOferDetNInc.Calculate
    wsOferDet.Calculate
    wsDestRec.Calculate

    passo = 3

    ' ========= 1) Linha destino (baseada em B, Q e S) =========
    nextRowB = wsDestino.Cells(wsDestino.Rows.Count, "B").End(xlUp).Row + 1
    nextRowQ = wsDestino.Cells(wsDestino.Rows.Count, "Q").End(xlUp).Row + 1
    nextRowS = wsDestino.Cells(wsDestino.Rows.Count, "S").End(xlUp).Row + 1
    targetRow = Application.WorksheetFunction.Max(nextRowB, nextRowQ, nextRowS)

    passo = 4

    ' ========= 2) VOLUME: copia última linha B:P =========
    lastRowOrigem = wsOrigem.Cells(wsOrigem.Rows.Count, "B").End(xlUp).Row
    arrVol = wsOrigem.Range("B" & lastRowOrigem & ":P" & lastRowOrigem).Value
    wsDestino.Range("B" & targetRow & ":P" & targetRow).Value = arrVol

    passo = 5

    ' B → mês/ano (robusto)
    SetMesAnoCellFromSourceText wsOrigem.Cells(lastRowOrigem, "B"), wsDestino.Cells(targetRow, "B")

    passo = 6

    ' C:P → /1e9 (robusto: converte texto)
    For c = wsDestino.Range("C1").Column To wsDestino.Range("P1").Column
        DividirCelulaPor1e9 wsDestino.Cells(targetRow, c), False
    Next c

    passo = 7

    ' ========= 3) PRAZO (não Inc): última linha (pela B) col C -> Q =========
    lastRowPrazo = wsPrazo.Cells(wsPrazo.Rows.Count, "B").End(xlUp).Row
    prazoValor = wsPrazo.Cells(lastRowPrazo, "C").Value
    wsDestino.Cells(targetRow, "Q").Value = prazoValor
    If IsNumeric(wsDestino.Cells(targetRow, "Q").Value) Then wsDestino.Cells(targetRow, "Q").NumberFormat = "0.0"

    passo = 8

    ' ========= 4) ENCERRADOS: última linha (pela B) B:D -> S:U =========
    lastRowEnc = wsEnc.Cells(wsEnc.Rows.Count, "B").End(xlUp).Row
    arrEnc = wsEnc.Range("B" & lastRowEnc & ":D" & lastRowEnc).Value
    wsDestino.Range("S" & targetRow & ":U" & targetRow).Value = arrEnc

    passo = 9

    ' S → mês/ano (robusto)
    SetMesAnoCellFromSourceText wsEnc.Cells(lastRowEnc, "B"), wsDestino.Cells(targetRow, "S")

    passo = 10

    ' T:U → /1e9
    DividirCelulaPor1e9 wsDestino.Cells(targetRow, "T"), False
    DividirCelulaPor1e9 wsDestino.Cells(targetRow, "U"), False

    passo = 11

    ' ========= 5) 12 431 Prazo Médio: última linha com dado na C -> AC =========
    lastRowPrazo12431 = wsPrazo12431.Cells(wsPrazo12431.Rows.Count, "C").End(xlUp).Row
    prazo12431Valor = wsPrazo12431.Cells(lastRowPrazo12431, "C").Value
    wsDestino.Cells(targetRow, "AC").Value = prazo12431Valor

    passo = 12

    ' ========= 6) PUXAR FÓRMULAS =========
    If targetRow > 1 Then
        PuxarFormulasLinha wsDestino, targetRow - 1, targetRow, "V:AA"
        PuxarFormulasLinha wsDestino, targetRow - 1, targetRow, "AD"
        PuxarFormulasLinha wsDestino, targetRow - 1, targetRow, "AL:AP"
        PuxarFormulasLinha wsDestino, targetRow - 1, targetRow, "AY"
        PuxarFormulasLinha wsDestino, targetRow - 1, targetRow, "BA:BD"
        PuxarFormulasLinha wsDestino, targetRow - 1, targetRow, "BR:BT"
    End If

    passo = 13

    ' ========= 7) Ofer Detentor N Inc: última linha (pela B) B:G -> AE:AJ =========
    lastRowOferDetNInc = wsOferDetNInc.Cells(wsOferDetNInc.Rows.Count, "B").End(xlUp).Row
    arrOferNInc = wsOferDetNInc.Range("B" & lastRowOferDetNInc & ":G" & lastRowOferDetNInc).Value
    wsDestino.Range("AE" & targetRow & ":AJ" & targetRow).Value = arrOferNInc

    passo = 14

    SetMesAnoCellFromSourceText wsOferDetNInc.Cells(lastRowOferDetNInc, "B"), wsDestino.Cells(targetRow, "AE")

    passo = 15

    For c = wsDestino.Range("AF1").Column To wsDestino.Range("AJ1").Column
        DividirCelulaPor1e9 wsDestino.Cells(targetRow, c), False
    Next c

    passo = 16

    ' ========= 8) 12 431 Ofer  Detentor: última linha (pela B) B:G -> AR:AW =========
    lastRowOferDet = wsOferDet.Cells(wsOferDet.Rows.Count, "B").End(xlUp).Row
    arrOfer = wsOferDet.Range("B" & lastRowOferDet & ":G" & lastRowOferDet).Value
    wsDestino.Range("AR" & targetRow & ":AW" & targetRow).Value = arrOfer

    passo = 17

    SetMesAnoCellFromSourceText wsOferDet.Cells(lastRowOferDet, "B"), wsDestino.Cells(targetRow, "AR")

    passo = 18

    For c = wsDestino.Range("AS1").Column To wsDestino.Range("AW1").Column
        DividirCelulaPor1e9 wsDestino.Cells(targetRow, c), True   ' 1 casa decimal
    Next c

    passo = 19

    ' ========= 9) Dest  Recursos: última linha (pela B) B:L -> BG:BP =========
    lastRowDestRec = wsDestRec.Cells(wsDestRec.Rows.Count, "B").End(xlUp).Row
    arrDestRec = wsDestRec.Range("B" & lastRowDestRec & ":L" & lastRowDestRec).Value
    wsDestino.Range("BG" & targetRow & ":BP" & targetRow).Value = arrDestRec

    passo = 20

    SetMesAnoCellFromSourceText wsDestRec.Cells(lastRowDestRec, "B"), wsDestino.Cells(targetRow, "BG")

    passo = 21

    For c = wsDestino.Range("BH1").Column To wsDestino.Range("BP1").Column
        DividirCelulaPor1e9 wsDestino.Cells(targetRow, c), True
    Next c

    passo = 22

    MsgBox "OK! Concluído.", vbInformation

CleanExit:
    Application.Calculation = oldCalc
    Application.EnableEvents = oldEvents
    Application.ScreenUpdating = oldScreen
    Exit Sub

EH:
    Application.Calculation = oldCalc
    Application.EnableEvents = oldEvents
    Application.ScreenUpdating = oldScreen
    MsgBox "Erro: " & Err.Number & " - " & Err.Description & vbCrLf & _
           "Passo: " & passo & vbCrLf & _
           "Dica: me manda esse 'Passo' que eu te digo a linha exata.", vbCritical
End Sub


' =======================
' COPIA FÓRMULAS
' =======================
Private Sub PuxarFormulasLinha(ByVal ws As Worksheet, ByVal srcRow As Long, ByVal dstRow As Long, ByVal cols As String)
    Dim p() As String
    Dim colStart As String, colEnd As String
    Dim addrSrc As String, addrDst As String

    cols = Replace(cols, " ", "")

    If InStr(1, cols, ":", vbTextCompare) > 0 Then
        p = Split(cols, ":")
        colStart = p(0)
        colEnd = p(1)
    Else
        colStart = cols
        colEnd = cols
    End If

    addrSrc = colStart & srcRow & ":" & colEnd & srcRow
    addrDst = colStart & dstRow & ":" & colEnd & dstRow

    ws.Range(addrDst).FormulaR1C1 = ws.Range(addrSrc).FormulaR1C1
End Sub


' =======================
' DATAS (robustas)
' =======================
Private Sub SetMesAnoCellFromSourceText(ByVal srcCell As Range, ByVal dstCell As Range)
    On Error GoTo SafeExit

    Dim txt As String, d As Variant
    Dim v As Variant, serial As Double

    txt = Trim$(srcCell.Text)
    d = ParseMMMYY_Safe(txt)

    If IsEmpty(d) Then d = ParseMMMYY_Safe(CStr(srcCell.Value))

    If Not IsEmpty(d) Then
        dstCell.Value = d
        dstCell.NumberFormat = "[$-pt-BR]mmm-yy"
        Exit Sub
    End If

    v = srcCell.Value2
    If IsNumeric(v) Then
        serial = CDbl(v)
        If serial >= 1# And serial <= 2958465# Then
            dstCell.Value = DateSerial(Year(CDate(serial)), Month(CDate(serial)), 1)
            dstCell.NumberFormat = "[$-pt-BR]mmm-yy"
        End If
    End If

SafeExit:
End Sub

Private Function ParseMMMYY_Safe(ByVal s As String) As Variant
    On Error GoTo Fail

    Dim t As String, parts() As String
    Dim mon As Long
    Dim yDigits As String, yyyy As String, yy As String
    Dim y As Long

    t = LCase$(Trim$(s))
    If t = "" Then GoTo Fail

    t = Replace(t, ChrW(160), "")
    t = Replace(t, " ", "")
    t = Replace(t, "/", "-")
    t = Replace(t, ".", "-")

    parts = Split(t, "-")
    If UBound(parts) < 1 Then GoTo Fail

    mon = MesParaNumeroPTEN(parts(0))
    If mon = 0 Then GoTo Fail

    yDigits = ExtrairDigitos(parts(1))
    If Len(yDigits) = 0 Then GoTo Fail

    If Len(yDigits) >= 4 Then
        yyyy = Right$(yDigits, 4)
        y = CLng(yyyy)
    Else
        yy = Right$(yDigits, 2)
        y = 2000 + CLng(yy)
    End If

    If y < 1900 Or y > 9999 Then GoTo Fail

    ParseMMMYY_Safe = DateSerial(y, mon, 1)
    Exit Function

Fail:
    ParseMMMYY_Safe = Empty
End Function

Private Function ExtrairDigitos(ByVal s As String) As String
    Dim i As Long, ch As String, out As String
    out = ""
    For i = 1 To Len(s)
        ch = Mid$(s, i, 1)
        If ch Like "#" Then out = out & ch
    Next i
    ExtrairDigitos = out
End Function

Private Function MesParaNumeroPTEN(ByVal m As String) As Long
    m = LCase$(Trim$(m))
    m = Left$(m, 3)

    Select Case m
        Case "jan": MesParaNumeroPTEN = 1
        Case "feb", "fev": MesParaNumeroPTEN = 2
        Case "mar": MesParaNumeroPTEN = 3
        Case "apr", "abr": MesParaNumeroPTEN = 4
        Case "may", "mai": MesParaNumeroPTEN = 5
        Case "jun": MesParaNumeroPTEN = 6
        Case "jul": MesParaNumeroPTEN = 7
        Case "aug", "ago": MesParaNumeroPTEN = 8
        Case "sep", "set": MesParaNumeroPTEN = 9
        Case "oct", "out": MesParaNumeroPTEN = 10
        Case "nov": MesParaNumeroPTEN = 11
        Case "dec", "dez": MesParaNumeroPTEN = 12
        Case Else: MesParaNumeroPTEN = 0
    End Select
End Function


' =======================
' DIVISÃO 1e9 (sem overflow)
' =======================
Private Sub DividirCelulaPor1e9(ByVal cell As Range, ByVal oneDecimal As Boolean)
    On Error GoTo SafeExit

    Dim dv As Variant
    dv = ToDoubleSafe(cell.Value)

    If Not IsEmpty(dv) Then
        cell.Value = CDbl(dv) / 1000000000#
        If oneDecimal Then cell.NumberFormat = "0.0"
    End If

SafeExit:
End Sub

Private Function ToDoubleSafe(ByVal v As Variant) As Variant
    On Error GoTo Fail

    If IsError(v) Or IsEmpty(v) Then GoTo Fail
    If IsNumeric(v) Then
        ToDoubleSafe = CDbl(v)
        Exit Function
    End If

    Dim s As String
    s = Trim$(CStr(v))
    If s = "" Then GoTo Fail

    s = Replace(s, ChrW(160), "")

    Dim i As Long, ch As String, clean As String
    clean = ""
    For i = 1 To Len(s)
        ch = Mid$(s, i, 1)
        If (ch Like "#") Or ch = "-" Or ch = "," Or ch = "." Then clean = clean & ch
    Next i
    If clean = "" Or clean = "-" Then GoTo Fail

    Dim pPos As Long, cPos As Long
    pPos = InStrRev(clean, ".")
    cPos = InStrRev(clean, ",")

    If pPos > 0 And cPos > 0 Then
        If pPos > cPos Then
            clean = Replace(clean, ",", "")
        Else
            clean = Replace(clean, ".", "")
            clean = Replace(clean, ",", ".")
        End If
    ElseIf cPos > 0 Then
        If Len(clean) - cPos = 3 Then
            clean = Replace(clean, ",", "")
        Else
            clean = Replace(clean, ",", ".")
        End If
    ElseIf pPos > 0 Then
        If Len(clean) - pPos = 3 Then
            clean = Replace(clean, ".", "")
        End If
    End If

    If IsNumeric(clean) Then
        ToDoubleSafe = CDbl(clean)
        Exit Function
    End If

Fail:
    ToDoubleSafe = Empty
End Function
