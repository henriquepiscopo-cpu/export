Sub CopiarUltimaLinhaVolume_Para_Deb_CRICRA()

    Dim wsOrigem As Worksheet
    Dim wsPrazo As Worksheet
    Dim wsEnc As Worksheet
    Dim wsPrazo12431 As Worksheet
    Dim wsDestino As Worksheet

    Dim lastRowOrigem As Long
    Dim lastRowPrazo As Long
    Dim lastRowEnc As Long
    Dim lastRowPrazo12431 As Long

    Dim nextRowB As Long
    Dim nextRowQ As Long
    Dim nextRowS As Long
    Dim targetRow As Long

    Dim c As Long
    Dim prazoValor As Variant
    Dim prazo12431Valor As Variant

    Dim arrVol As Variant
    Dim arrEnc As Variant

    Dim oldCalc As XlCalculation
    Dim oldEvents As Boolean
    Dim oldScreen As Boolean

    On Error GoTo EH

    ' ===== Performance / evita evento interferindo =====
    oldCalc = Application.Calculation
    oldEvents = Application.EnableEvents
    oldScreen = Application.ScreenUpdating

    Application.ScreenUpdating = False
    Application.EnableEvents = False
    Application.Calculation = xlCalculationManual

    ' ===== Abas =====
    Set wsOrigem = ThisWorkbook.Worksheets("Volume")
    Set wsDestino = ThisWorkbook.Worksheets("Deb, CRICRA FII Fiagro (Mensal)")
    Set wsPrazo = ThisWorkbook.Worksheets("Prazo Médio não Inc")
    Set wsEnc = ThisWorkbook.Worksheets("12 431 V  Encerrados")          ' ajuste se tiver 1 espaço só
    Set wsPrazo12431 = ThisWorkbook.Worksheets("12 431 Prazo Médio")     ' NOVA

    ' ========= 1) ACHA LINHA DE DESTINO (baseada em B, Q e S) =========
    nextRowB = wsDestino.Cells(wsDestino.Rows.Count, "B").End(xlUp).Row + 1
    nextRowQ = wsDestino.Cells(wsDestino.Rows.Count, "Q").End(xlUp).Row + 1
    nextRowS = wsDestino.Cells(wsDestino.Rows.Count, "S").End(xlUp).Row + 1

    targetRow = Application.WorksheetFunction.Max(nextRowB, nextRowQ, nextRowS)

    ' ========= 2) VOLUME: COPIA ÚLTIMA LINHA B:P =========
    lastRowOrigem = wsOrigem.Cells(wsOrigem.Rows.Count, "B").End(xlUp).Row
    arrVol = wsOrigem.Range("B" & lastRowOrigem & ":P" & lastRowOrigem).Value
    wsDestino.Range("B" & targetRow & ":P" & targetRow).Value = arrVol

    ' Coluna B → data (mês/ano) "nov-25"
    With wsDestino.Cells(targetRow, "B")
        If IsDate(.Value) Then
            .Value = DateSerial(Year(CDate(.Value)), Month(CDate(.Value)), 1)
            .NumberFormat = "mmm-yy"
        End If
    End With

    ' Colunas C:P → dividir por 1.000.000.000
    For c = wsDestino.Range("C1").Column To wsDestino.Range("P1").Column
        With wsDestino.Cells(targetRow, c)
            If IsNumeric(.Value) And Not IsEmpty(.Value) Then
                .Value = .Value / 1000000000#
            End If
        End With
    Next c

    ' ========= 3) PRAZO (não Inc): ÚLTIMA LINHA (pela B) COLUNA C -> COLUNA Q =========
    lastRowPrazo = wsPrazo.Cells(wsPrazo.Rows.Count, "B").End(xlUp).Row
    prazoValor = wsPrazo.Cells(lastRowPrazo, "C").Value
    wsDestino.Cells(targetRow, "Q").Value = prazoValor

    ' Formata Q com 1 casa decimal
    With wsDestino.Cells(targetRow, "Q")
        If IsNumeric(.Value) And Not IsEmpty(.Value) Then
            .NumberFormat = "0.0"
        End If
    End With

    ' ========= 4) ENCERRADOS: ÚLTIMA LINHA (pela B) COPIA B:D -> COLA S:U =========
    lastRowEnc = wsEnc.Cells(wsEnc.Rows.Count, "B").End(xlUp).Row

    ' Fonte: B:D
    arrEnc = wsEnc.Range("B" & lastRowEnc & ":D" & lastRowEnc).Value

    ' Destino: S:U
    wsDestino.Range("S" & targetRow & ":U" & targetRow).Value = arrEnc

    ' Coluna S → data (mês/ano) "nov-25"
    With wsDestino.Cells(targetRow, "S")
        If IsDate(.Value) Then
            .Value = DateSerial(Year(CDate(.Value)), Month(CDate(.Value)), 1)
            .NumberFormat = "mmm-yy"
        End If
    End With

    ' Colunas T:U → dividir por 1.000.000.000
    For c = wsDestino.Range("T1").Column To wsDestino.Range("U1").Column
        With wsDestino.Cells(targetRow, c)
            If IsNumeric(.Value) And Not IsEmpty(.Value) Then
                .Value = .Value / 1000000000#
            End If
        End With
    Next c

    ' ========= 5) 12 431 Prazo Médio: última linha com dado na COLUNA C -> cola em AC =========
    lastRowPrazo12431 = wsPrazo12431.Cells(wsPrazo12431.Rows.Count, "C").End(xlUp).Row
    prazo12431Valor = wsPrazo12431.Cells(lastRowPrazo12431, "C").Value

    wsDestino.Cells(targetRow, "AC").Value = prazo12431Valor

    ' ========= 6) PUXAR FÓRMULAS ATÉ A LINHA DESTINO =========
    ' Copia as fórmulas da linha anterior (targetRow-1) para targetRow
    If targetRow > 2 Then
        Call PuxarFormulasLinha(wsDestino, targetRow - 1, targetRow, "V:AA")
        Call PuxarFormulasLinha(wsDestino, targetRow - 1, targetRow, "AD:AD")
        Call PuxarFormulasLinha(wsDestino, targetRow - 1, targetRow, "AL:AP")
        Call PuxarFormulasLinha(wsDestino, targetRow - 1, targetRow, "AY:AY")
        Call PuxarFormulasLinha(wsDestino, targetRow - 1, targetRow, "BA:BD")
        Call PuxarFormulasLinha(wsDestino, targetRow - 1, targetRow, "BR:BT")
    End If

    MsgBox "OK! Atualizado (B:P + Q + S:U + AC + fórmulas).", vbInformation

CleanExit:
    Application.Calculation = oldCalc
    Application.EnableEvents = oldEvents
    Application.ScreenUpdating = oldScreen
    Exit Sub

EH:
    Application.Calculation = oldCalc
    Application.EnableEvents = oldEvents
    Application.ScreenUpdating = oldScreen
    MsgBox "Erro: " & Err.Number & " - " & Err.Description, vbCritical

End Sub


Private Sub PuxarFormulasLinha(ByVal ws As Worksheet, ByVal srcRow As Long, ByVal dstRow As Long, ByVal cols As String)
    ' Copia somente fórmulas (não valores) da linha srcRow para dstRow no intervalo de colunas informado
    Dim rngSrc As Range, rngDst As Range
    Set rngSrc = ws.Range(cols & srcRow)
    Set rngDst = ws.Range(cols & dstRow)
    rngDst.FormulaR1C1 = rngSrc.FormulaR1C1
End Sub

