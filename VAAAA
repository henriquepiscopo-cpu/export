Option Explicit

Sub CopiarUltimaLinhaVolume_Para_Deb_CRICRA()

    Dim wsOrigem As Worksheet
    Dim wsPrazo As Worksheet
    Dim wsEnc As Worksheet
    Dim wsPrazo12431 As Worksheet
    Dim wsOferDetNInc As Worksheet
    Dim wsOferDet As Worksheet
    Dim wsDestRec As Worksheet
    Dim wsDestino As Worksheet

    Dim lastRowOrigem As Long
    Dim lastRowPrazo As Long
    Dim lastRowEnc As Long
    Dim lastRowPrazo12431 As Long
    Dim lastRowOferDetNInc As Long
    Dim lastRowOferDet As Long
    Dim lastRowDestRec As Long

    Dim nextRowB As Long
    Dim nextRowQ As Long
    Dim nextRowS As Long
    Dim targetRow As Long

    Dim c As Long
    Dim prazoValor As Variant
    Dim prazo12431Valor As Variant

    Dim arrVol As Variant
    Dim arrEnc As Variant
    Dim arrOferNInc As Variant
    Dim arrOfer As Variant
    Dim arrDestRec As Variant

    Dim oldCalc As XlCalculation
    Dim oldEvents As Boolean
    Dim oldScreen As Boolean

    On Error GoTo EH

    ' ===== Performance / evita evento interferindo =====
    oldCalc = Application.Calculation
    oldEvents = Application.EnableEvents
    oldScreen = Application.ScreenUpdating

    Application.ScreenUpdating = False
    Application.EnableEvents = False
    Application.Calculation = xlCalculationManual

    ' ===== Abas =====
    Set wsOrigem = ThisWorkbook.Worksheets("Volume")
    Set wsDestino = ThisWorkbook.Worksheets("Deb, CRICRA FII Fiagro (Mensal)")
    Set wsPrazo = ThisWorkbook.Worksheets("Prazo Médio não Inc")
    Set wsEnc = ThisWorkbook.Worksheets("12 431 V  Encerrados")
    Set wsPrazo12431 = ThisWorkbook.Worksheets("12 431 Prazo Médio")
    Set wsOferDetNInc = ThisWorkbook.Worksheets("Ofer  Detentor N Inc")
    Set wsOferDet = ThisWorkbook.Worksheets("12 431 Ofer  Detentor")
    Set wsDestRec = ThisWorkbook.Worksheets("Dest  Recursos")

    ' ========= 1) ACHA LINHA DE DESTINO (baseada em B, Q e S) =========
    nextRowB = wsDestino.Cells(wsDestino.Rows.Count, "B").End(xlUp).Row + 1
    nextRowQ = wsDestino.Cells(wsDestino.Rows.Count, "Q").End(xlUp).Row + 1
    nextRowS = wsDestino.Cells(wsDestino.Rows.Count, "S").End(xlUp).Row + 1
    targetRow = Application.WorksheetFunction.Max(nextRowB, nextRowQ, nextRowS)

    ' ========= 2) VOLUME: COPIA ÚLTIMA LINHA B:P =========
    lastRowOrigem = wsOrigem.Cells(wsOrigem.Rows.Count, "B").End(xlUp).Row
    arrVol = wsOrigem.Range("B" & lastRowOrigem & ":P" & lastRowOrigem).Value
    wsDestino.Range("B" & targetRow & ":P" & targetRow).Value = arrVol

    ' Coluna B → data (mês/ano) "mar-12" / "nov-25" (robusto)
    SetMesAnoCell wsDestino.Cells(targetRow, "B")

    ' Colunas C até P → dividir por 1.000.000.000
    For c = wsDestino.Range("C1").Column To wsDestino.Range("P1").Column
        With wsDestino.Cells(targetRow, c)
            If IsNumeric(.Value) And Not IsEmpty(.Value) Then .Value = .Value / 1000000000#
        End With
    Next c

    ' ========= 3) PRAZO (não Inc): ÚLTIMA LINHA (pela B) COL C -> COL Q =========
    lastRowPrazo = wsPrazo.Cells(wsPrazo.Rows.Count, "B").End(xlUp).Row
    prazoValor = wsPrazo.Cells(lastRowPrazo, "C").Value
    wsDestino.Cells(targetRow, "Q").Value = prazoValor

    ' Formata Q com 1 casa decimal
    With wsDestino.Cells(targetRow, "Q")
        If IsNumeric(.Value) And Not IsEmpty(.Value) Then .NumberFormat = "0.0"
    End With

    ' ========= 4) ENCERRADOS: ÚLTIMA LINHA (pela B) COPIA B:D -> COLA S:U =========
    lastRowEnc = wsEnc.Cells(wsEnc.Rows.Count, "B").End(xlUp).Row
    arrEnc = wsEnc.Range("B" & lastRowEnc & ":D" & lastRowEnc).Value
    wsDestino.Range("S" & targetRow & ":U" & targetRow).Value = arrEnc

    ' Coluna S → data "mar-12" (robusto)
    SetMesAnoCell wsDestino.Cells(targetRow, "S")

    ' Colunas T:U → dividir por 1.000.000.000
    For c = wsDestino.Range("T1").Column To wsDestino.Range("U1").Column
        With wsDestino.Cells(targetRow, c)
            If IsNumeric(.Value) And Not IsEmpty(.Value) Then .Value = .Value / 1000000000#
        End With
    Next c

    ' ========= 5) 12 431 Prazo Médio: última linha com dado na COL C -> cola em AC =========
    lastRowPrazo12431 = wsPrazo12431.Cells(wsPrazo12431.Rows.Count, "C").End(xlUp).Row
    prazo12431Valor = wsPrazo12431.Cells(lastRowPrazo12431, "C").Value
    wsDestino.Cells(targetRow, "AC").Value = prazo12431Valor

    ' ========= 6) PUXAR FÓRMULAS (da linha anterior -> targetRow) =========
    If targetRow > 1 Then
        PuxarFormulasLinha wsDestino, targetRow - 1, targetRow, "V:AA"
        PuxarFormulasLinha wsDestino, targetRow - 1, targetRow, "AD"
        PuxarFormulasLinha wsDestino, targetRow - 1, targetRow, "AL:AP"
        PuxarFormulasLinha wsDestino, targetRow - 1, targetRow, "AY"
        PuxarFormulasLinha wsDestino, targetRow - 1, targetRow, "BA:BD"
        PuxarFormulasLinha wsDestino, targetRow - 1, targetRow, "BR:BT"
    End If

    ' ========= 7) Ofer Detentor N Inc: última linha pela COL B -> B:G em AE:AJ =========
    lastRowOferDetNInc = wsOferDetNInc.Cells(wsOferDetNInc.Rows.Count, "B").End(xlUp).Row
    arrOferNInc = wsOferDetNInc.Range("B" & lastRowOferDetNInc & ":G" & lastRowOferDetNInc).Value
    wsDestino.Range("AE" & targetRow & ":AJ" & targetRow).Value = arrOferNInc

    ' AE → data "mar-12"
    SetMesAnoCell wsDestino.Cells(targetRow, "AE")

    ' AF:AJ → /1e9
    For c = wsDestino.Range("AF1").Column To wsDestino.Range("AJ1").Column
        With wsDestino.Cells(targetRow, c)
            If IsNumeric(.Value) And Not IsEmpty(.Value) Then .Value = .Value / 1000000000#
        End With
    Next c

    ' ========= 8) 12 431 Ofer  Detentor: última linha pela COL B -> B:G em AR:AW =========
    lastRowOferDet = wsOferDet.Cells(wsOferDet.Rows.Count, "B").End(xlUp).Row
    arrOfer = wsOferDet.Range("B" & lastRowOferDet & ":G" & lastRowOferDet).Value
    wsDestino.Range("AR" & targetRow & ":AW" & targetRow).Value = arrOfer

    ' AR → data "mar-12"
    SetMesAnoCell wsDestino.Cells(targetRow, "AR")

    ' AS:AW → /1e9 e 1 casa decimal
    For c = wsDestino.Range("AS1").Column To wsDestino.Range("AW1").Column
        With wsDestino.Cells(targetRow, c)
            If IsNumeric(.Value) And Not IsEmpty(.Value) Then
                .Value = .Value / 1000000000#
                .NumberFormat = "0.0"
            End If
        End With
    Next c

    ' ========= 9) Dest  Recursos: última linha pela COL B -> B:L em BG:BP =========
    lastRowDestRec = wsDestRec.Cells(wsDestRec.Rows.Count, "B").End(xlUp).Row
    arrDestRec = wsDestRec.Range("B" & lastRowDestRec & ":L" & lastRowDestRec).Value
    wsDestino.Range("BG" & targetRow & ":BP" & targetRow).Value = arrDestRec

    ' BG → data "mar-12"
    SetMesAnoCell wsDestino.Cells(targetRow, "BG")

    ' BH:BP → /1e9 e 1 casa decimal
    For c = wsDestino.Range("BH1").Column To wsDestino.Range("BP1").Column
        With wsDestino.Cells(targetRow, c)
            If IsNumeric(.Value) And Not IsEmpty(.Value) Then
                .Value = .Value / 1000000000#
                .NumberFormat = "0.0"
            End If
        End With
    Next c

    MsgBox "OK! Atualizado até Dest  Recursos (BG:BP) + datas fixas (mar-12/nov-25).", vbInformation

CleanExit:
    Application.Calculation = oldCalc
    Application.EnableEvents = oldEvents
    Application.ScreenUpdating = oldScreen
    Exit Sub

EH:
    Application.Calculation = oldCalc
    Application.EnableEvents = oldEvents
    Application.ScreenUpdating = oldScreen
    MsgBox "Erro: " & Err.Number & " - " & Err.Description, vbCritical

End Sub


Private Sub PuxarFormulasLinha(ByVal ws As Worksheet, ByVal srcRow As Long, ByVal dstRow As Long, ByVal cols As String)
    Dim p() As String
    Dim colStart As String, colEnd As String
    Dim addrSrc As String, addrDst As String

    cols = Replace(cols, " ", "")

    If InStr(1, cols, ":", vbTextCompare) > 0 Then
        p = Split(cols, ":")
        colStart = p(0)
        colEnd = p(1)
    Else
        colStart = cols
        colEnd = cols
    End If

    addrSrc = colStart & srcRow & ":" & colEnd & srcRow
    addrDst = colStart & dstRow & ":" & colEnd & dstRow

    ws.Range(addrDst).FormulaR1C1 = ws.Range(addrSrc).FormulaR1C1
End Sub


Private Function MesPtParaNumero(ByVal m As String) As Long
    m = LCase$(Trim$(m))
    If Left$(m, 3) = "jan" Then MesPtParaNumero = 1: Exit Function
    If Left$(m, 3) = "fev" Then MesPtParaNumero = 2: Exit Function
    If Left$(m, 3) = "mar" Then MesPtParaNumero = 3: Exit Function
    If Left$(m, 3) = "abr" Then MesPtParaNumero = 4: Exit Function
    If Left$(m, 3) = "mai" Then MesPtParaNumero = 5: Exit Function
    If Left$(m, 3) = "jun" Then MesPtParaNumero = 6: Exit Function
    If Left$(m, 3) = "jul" Then MesPtParaNumero = 7: Exit Function
    If Left$(m, 3) = "ago" Then MesPtParaNumero = 8: Exit Function
    If Left$(m, 3) = "set" Then MesPtParaNumero = 9: Exit Function
    If Left$(m, 3) = "out" Then MesPtParaNumero = 10: Exit Function
    If Left$(m, 3) = "nov" Then MesPtParaNumero = 11: Exit Function
    If Left$(m, 3) = "dez" Then MesPtParaNumero = 12: Exit Function
    MesPtParaNumero = 0
End Function

Private Function ParseMesAno(ByVal v As Variant) As Variant
    Dim s As String, parts() As String
    Dim mTxt As String, mNum As Long, y As Long, yy As Long

    If IsEmpty(v) Or v = "" Then
        ParseMesAno = Empty
        Exit Function
    End If

    If IsDate(v) Then
        ParseMesAno = DateSerial(Year(CDate(v)), Month(CDate(v)), 1)
        Exit Function
    End If

    s = LCase$(Trim$(CStr(v)))
    s = Replace(s, ".", "")
    s = Replace(s, " ", "")
    s = Replace(s, "/", "-")

    parts = Split(s, "-")
    If UBound(parts) < 1 Then
        ParseMesAno = Empty
        Exit Function
    End If

    mTxt = parts(0)
    mNum = MesPtParaNumero(mTxt)
    If mNum = 0 Then
        ParseMesAno = Empty
        Exit Function
    End If

    If Len(parts(1)) = 2 Then
        yy = CLng(parts(1))
        y = 2000 + yy
    Else
        y = CLng(parts(1))
        If y < 100 Then y = 2000 + y
    End If

    ParseMesAno = DateSerial(y, mNum, 1)
End Function

Private Sub SetMesAnoCell(ByVal cell As Range)
    Dim d As Variant
    d = ParseMesAno(cell.Value)
    If Not IsEmpty(d) Then
        cell.Value = d
        ' FORÇA exatamente: mar-12 / nov-25 (PT-BR + ano 2 dígitos)
        cell.NumberFormat = "[$-pt-BR]mmm-yy"
    End If
End Sub
