Sub CopiarUltimaLinhaVolume_Para_Deb_CRICRA()

    Dim wsOrigem As Worksheet
    Dim wsPrazo As Worksheet
    Dim wsEnc As Worksheet
    Dim wsDestino As Worksheet

    Dim lastRowOrigem As Long
    Dim lastRowPrazo As Long
    Dim lastRowEnc As Long

    Dim nextRowB As Long, nextRowQ As Long, nextRowS As Long
    Dim targetRow As Long

    Dim prazoValor As Variant
    Dim arrVol As Variant
    Dim arrEnc As Variant
    Dim c As Long, r As Long

    Dim oldCalc As XlCalculation
    Dim oldEvents As Boolean
    Dim oldScreen As Boolean

    On Error GoTo EH

    ' ===== Performance / evita "piscar e sumir" =====
    oldCalc = Application.Calculation
    oldEvents = Application.EnableEvents
    oldScreen = Application.ScreenUpdating

    Application.ScreenUpdating = False
    Application.EnableEvents = False
    Application.Calculation = xlCalculationManual

    ' ===== Abas =====
    Set wsOrigem = ThisWorkbook.Worksheets("Volume")
    Set wsDestino = ThisWorkbook.Worksheets("Deb, CRICRA FII Fiagro (Mensal)")
    Set wsPrazo = ThisWorkbook.Worksheets("Prazo Médio não Inc")
    Set wsEnc = ThisWorkbook.Worksheets("12 431 V  Encerrados") ' <- 2 espaços

    ' ========= 1) ACHA LINHA DE DESTINO (baseada em B, Q e S) =========
    nextRowB = wsDestino.Cells(wsDestino.Rows.Count, "B").End(xlUp).Row + 1
    nextRowQ = wsDestino.Cells(wsDestino.Rows.Count, "Q").End(xlUp).Row + 1
    nextRowS = wsDestino.Cells(wsDestino.Rows.Count, "S").End(xlUp).Row + 1
    targetRow = Application.WorksheetFunction.Max(nextRowB, nextRowQ, nextRowS)

    ' ========= 2) VOLUME: ÚLTIMA LINHA PELA COLUNA B -> COLA B:P =========
    lastRowOrigem = wsOrigem.Cells(wsOrigem.Rows.Count, "B").End(xlUp).Row

    arrVol = wsOrigem.Range("B" & lastRowOrigem & ":P" & lastRowOrigem).Value
    wsDestino.Range("B" & targetRow & ":P" & targetRow).Value = arrVol

    ' Coluna B → data mês/ano "nov-25"
    With wsDestino.Cells(targetRow, "B")
        If IsDate(.Value) Then
            .Value = DateSerial(Year(CDate(.Value)), Month(CDate(.Value)), 1)
            .NumberFormat = "mmm-yy"
        End If
    End With

    ' Colunas C:P → dividir por 1.000.000.000
    For c = wsDestino.Range("C1").Column To wsDestino.Range("P1").Column
        With wsDestino.Cells(targetRow, c)
            If IsNumeric(.Value) And Not IsEmpty(.Value) Then
                .Value = .Value / 1000000000#
            End If
        End With
    Next c

    ' ========= 3) PRAZO: ÚLTIMA LINHA (pela B) COL C -> COLA Q =========
    lastRowPrazo = wsPrazo.Cells(wsPrazo.Rows.Count, "B").End(xlUp).Row
    prazoValor = wsPrazo.Cells(lastRowPrazo, "C").Value

    wsDestino.Cells(targetRow, "Q").Value = prazoValor
    With wsDestino.Cells(targetRow, "Q")
        If IsNumeric(.Value) And Not IsEmpty(.Value) Then .NumberFormat = "0.0"
    End With

    ' ========= 4) ENCERRADOS: ÚLTIMA LINHA "VÁLIDA" NA COLUNA B -> COLA S:U =========
    lastRowEnc = 0
    For r = wsEnc.Cells(wsEnc.Rows.Count, "B").End(xlUp).Row To 1 Step -1
        If Trim$(CStr(wsEnc.Cells(r, "B").Value)) <> "" Then
            ' se quiser ignorar "Total"/"Fonte", mantenha; senão pode remover
            If LCase$(Trim$(CStr(wsEnc.Cells(r, "B").Value))) <> "total" _
               And LCase$(Trim$(CStr(wsEnc.Cells(r, "B").Value))) <> "fonte" Then
                lastRowEnc = r
                Exit For
            End If
        End If
    Next r

    If lastRowEnc = 0 Then
        MsgBox "Não achei nenhuma linha válida na coluna B da aba '12 431 V  Encerrados'.", vbCritical
        GoTo CleanExit
    End If

    arrEnc = wsEnc.Range("S" & lastRowEnc & ":U" & lastRowEnc).Value

    ' Escreve direto (sem paste) — sobrescreve fórmula também
    wsDestino.Range("S" & targetRow & ":U" & targetRow).Value = arrEnc

    ' Coluna S → data mês/ano "nov-25"
    With wsDestino.Cells(targetRow, "S")
        If IsDate(.Value) Then
            .Value = DateSerial(Year(CDate(.Value)), Month(CDate(.Value)), 1)
            .NumberFormat = "mmm-yy"
        End If
    End With

    ' Colunas T:U → dividir por 1.000.000.000
    For c = wsDestino.Range("T1").Column To wsDestino.Range("U1").Column
        With wsDestino.Cells(targetRow, c)
            If IsNumeric(.Value) And Not IsEmpty(.Value) Then
                .Value = .Value / 1000000000#
            End If
        End With
    Next c

    MsgBox "Dados copiados e tratados com sucesso! (B:P + Q + S:U)", vbInformation

CleanExit:
    Application.Calculation = oldCalc
    Application.EnableEvents = oldEvents
    Application.ScreenUpdating = oldScreen
    Exit Sub

EH:
    ' garante que volta ao normal mesmo com erro
    Application.Calculation = oldCalc
    Application.EnableEvents = oldEvents
    Application.ScreenUpdating = oldScreen
    MsgBox "Erro: " & Err.Number & " - " & Err.Description, vbCritical

End Sub
