Option Explicit

'========================
' CONFIG (AJUSTE SE PRECISAR)
'========================
Private Const START_ROW_TABELA As Long = 5   ' a tabela começa na linha 5

'========================
' AUXILIARES (tabela)
'========================
Private Function LinhaFimTabelaPorVazio(ws As Worksheet, ByVal colLetra As String, ByVal startRow As Long) As Long
    Dim r As Long
    r = startRow
    Do While Trim$(CStr(ws.Cells(r, colLetra).Value)) <> ""
        r = r + 1
        If r > ws.Rows.Count Then Exit Do
    Loop
    LinhaFimTabelaPorVazio = r - 1
End Function

Private Function LinhaDaMaiorDataNoBloco(ws As Worksheet, ByVal colLetra As String, ByVal startRow As Long) As Long
    Dim endRow As Long, r As Long
    Dim bestRow As Long
    Dim bestDate As Date
    Dim v As Variant

    endRow = LinhaFimTabelaPorVazio(ws, colLetra, startRow)
    If endRow < startRow Then
        LinhaDaMaiorDataNoBloco = 0
        Exit Function
    End If

    bestRow = 0
    bestDate = DateSerial(1900, 1, 1)

    For r = startRow To endRow
        v = ws.Cells(r, colLetra).Value
        If IsDate(v) Then
            If CDate(v) > bestDate Then
                bestDate = CDate(v)
                bestRow = r
            End If
        End If
    Next r

    LinhaDaMaiorDataNoBloco = bestRow
End Function

Private Function LinhaParaColarDepoisDaTabela(ws As Worksheet, ByVal colLetra As String, ByVal startRow As Long) As Long
    LinhaParaColarDepoisDaTabela = LinhaFimTabelaPorVazio(ws, colLetra, startRow) + 1
End Function

Private Sub PuxarFormulasLinha(ByVal ws As Worksheet, ByVal srcRow As Long, ByVal dstRow As Long, ByVal cols As String)
    Dim p() As String
    Dim colStart As String, colEnd As String
    Dim addrSrc As String, addrDst As String

    cols = Replace(cols, " ", "")

    If InStr(1, cols, ":", vbTextCompare) > 0 Then
        p = Split(cols, ":")
        colStart = p(0)
        colEnd = p(1)
    Else
        colStart = cols
        colEnd = cols
    End If

    addrSrc = colStart & srcRow & ":" & colEnd & srcRow
    addrDst = colStart & dstRow & ":" & colEnd & dstRow

    ws.Range(addrDst).FormulaR1C1 = ws.Range(addrSrc).FormulaR1C1
End Sub

'========================
' AUXILIARES (SUM shift)
'========================
Private Function FindMatchingParen(ByVal s As String, ByVal posAfterSum As Long) As Long
    Dim pOpen As Long, i As Long, depth As Long
    pOpen = InStr(posAfterSum, s, "(")
    If pOpen = 0 Then
        FindMatchingParen = 0
        Exit Function
    End If

    depth = 0
    For i = pOpen To Len(s)
        If Mid$(s, i, 1) = "(" Then depth = depth + 1
        If Mid$(s, i, 1) = ")" Then
            depth = depth - 1
            If depth = 0 Then
                FindMatchingParen = i
                Exit Function
            End If
        End If
    Next i

    FindMatchingParen = 0
End Function

Private Function IncrementarRefsDentroDoTexto(ByVal txt As String, ByVal delta As Long) As String
    Dim re As Object, matches As Object, m As Object
    Dim result As String
    Dim lastIdx As Long
    Dim colPart As String, rowNum As Long
    Dim startAt As Long

    Set re = CreateObject("VBScript.RegExp")
    re.Global = True
    re.IgnoreCase = True
    re.Pattern = "(\$?[A-Z]{1,3}\$?)(\d+)"

    Set matches = re.Execute(txt)
    If matches.Count = 0 Then
        IncrementarRefsDentroDoTexto = txt
        Exit Function
    End If

    result = ""
    lastIdx = 1

    For Each m In matches
        startAt = m.FirstIndex + 1
        result = result & Mid$(txt, lastIdx, startAt - lastIdx)

        colPart = m.SubMatches(0)
        rowNum = CLng(m.SubMatches(1)) + delta

        result = result & colPart & CStr(rowNum)
        lastIdx = startAt + Len(m.Value)
    Next m

    result = result & Mid$(txt, lastIdx)
    IncrementarRefsDentroDoTexto = result
End Function

Private Function IncrementarLinhasEmSums(ByVal formula As String, ByVal delta As Long) As String
    Dim i As Long
    Dim out As String
    Dim startPos As Long, endPos As Long
    Dim beforePart As String, insidePart As String, afterPart As String
    Dim lowerF As String

    lowerF = LCase$(formula)
    out = formula
    i = 1

    Do
        startPos = InStr(i, lowerF, "sum(")
        If startPos = 0 Then startPos = InStr(i, lowerF, "soma(")
        If startPos = 0 Then Exit Do

        endPos = FindMatchingParen(out, startPos + 3)
        If endPos = 0 Then Exit Do

        beforePart = Left$(out, startPos - 1)
        insidePart = Mid$(out, startPos, endPos - startPos + 1)
        afterPart = Mid$(out, endPos + 1)

        insidePart = IncrementarRefsDentroDoTexto(insidePart, delta)

        out = beforePart & insidePart & afterPart
        lowerF = LCase$(out)

        i = endPos + 1
    Loop

    IncrementarLinhasEmSums = out
End Function

Private Sub DescerIntervaloSUM_Linha72_C_AC_Anual()
    Dim ws As Worksheet
    Dim r As Long, c As Long
    Dim cell As Range
    Dim f As String

    Set ws = ThisWorkbook.Worksheets("Deb, CRICRA FII Fiagro (Anual)")
    r = 72

    For c = ws.Range("C1").Column To ws.Range("AC1").Column
        Set cell = ws.Cells(r, c)

        If cell.HasFormula Then
            f = cell.Formula
            If InStr(1, f, "SUM(", vbTextCompare) > 0 Or InStr(1, f, "SOMA(", vbTextCompare) > 0 Then
                cell.Formula = IncrementarLinhasEmSums(f, 1) ' desce 1 linha
            End If
        End If
    Next c
End Sub

'========================
' MACRO PRINCIPAL (BOTÃO)
'========================
Sub CopiarUltimaLinha_Mensal_Para_Anual()

    Dim wsSrc As Worksheet, wsDst As Worksheet
    Dim srcRow As Long
    Dim dstRow As Long

    Dim oldCalc As XlCalculation
    Dim oldEvents As Boolean
    Dim oldScreen As Boolean

    On Error GoTo EH

    oldCalc = Application.Calculation
    oldEvents = Application.EnableEvents
    oldScreen = Application.ScreenUpdating

    Application.ScreenUpdating = False
    Application.EnableEvents = False
    Application.Calculation = xlCalculationManual

    Set wsSrc = ThisWorkbook.Worksheets("Deb, CRICRA FII Fiagro (Mensal)")
    Set wsDst = ThisWorkbook.Worksheets("Deb, CRICRA FII Fiagro (Anual)")

    ' ORIGEM: maior data no bloco (col B)
    srcRow = LinhaDaMaiorDataNoBloco(wsSrc, "B", START_ROW_TABELA)
    If srcRow = 0 Then Err.Raise 5, , "Não encontrei nenhuma data válida na origem (coluna B, a partir da linha 5)."

    ' DESTINO: cola depois do fim da tabela (col B)
    dstRow = LinhaParaColarDepoisDaTabela(wsDst, "B", START_ROW_TABELA)

    ' =========================================================
    ' 1) PRIMEIRA PARTE (B + D:Q -> B:P)
    ' =========================================================
    wsDst.Cells(dstRow, "B").Value = wsSrc.Cells(srcRow, "B").Value
    wsDst.Range("C" & dstRow & ":P" & dstRow).Value = wsSrc.Range("D" & srcRow & ":Q" & srcRow).Value

    ' =========================================================
    ' 2) S:U (origem) -> R:T (destino)
    ' =========================================================
    wsDst.Range("R" & dstRow & ":T" & dstRow).Value = wsSrc.Range("S" & srcRow & ":U" & srcRow).Value

    ' =========================================================
    ' 3) Puxar fórmulas U:Z (linha anterior -> linha destino)
    ' =========================================================
    If dstRow > START_ROW_TABELA Then
        PuxarFormulasLinha wsDst, dstRow - 1, dstRow, "U:Z"
    End If

    ' =========================================================
    ' 4) AC:AD (origem) -> AB:AC (destino)
    ' =========================================================
    wsDst.Range("AB" & dstRow & ":AC" & dstRow).Value = wsSrc.Range("AC" & srcRow & ":AD" & srcRow).Value

    ' =========================================================
    ' 5) AJUSTE LINHA 72 (C:AC) - DESCE INTERVALO DAS SOMAS
    ' =========================================================
    DescerIntervaloSUM_Linha72_C_AC_Anual

    MsgBox "OK! Copiado Mensal -> Anual + ajustado SUMs na linha 72 (C:AC).", vbInformation

CleanExit:
    Application.Calculation = oldCalc
    Application.EnableEvents = oldEvents
    Application.ScreenUpdating = oldScreen
    Exit Sub

EH:
    Application.Calculation = oldCalc
    Application.EnableEvents = oldEvents
    Application.ScreenUpdating = oldScreen
    MsgBox "Erro: " & Err.Number & " - " & Err.Description, vbCritical
End Sub
