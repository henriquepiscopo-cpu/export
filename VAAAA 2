Option Explicit

'========================
' AUXILIARES
'========================
Private Function LinhaDaMaiorData(ws As Worksheet, ByVal colLetra As String) As Long
    Dim maxDate As Date
    Dim r As Range

    On Error GoTo Fail
    maxDate = Application.WorksheetFunction.Max(ws.Range(colLetra & ":" & colLetra))

    Set r = ws.Range(colLetra & ":" & colLetra).Find( _
                What:=maxDate, _
                LookIn:=xlValues, _
                LookAt:=xlWhole _
            )

    If r Is Nothing Then
        LinhaDaMaiorData = 0
    Else
        LinhaDaMaiorData = r.Row
    End If
    Exit Function

Fail:
    LinhaDaMaiorData = 0
End Function

Private Function LinhaDepoisDaMaiorData(ws As Worksheet, ByVal colLetra As String) As Long
    Dim linhaMax As Long
    linhaMax = LinhaDaMaiorData(ws, colLetra)

    If linhaMax = 0 Then
        ' fallback: depois do último usado
        LinhaDepoisDaMaiorData = ws.Cells(ws.Rows.Count, colLetra).End(xlUp).Row + 1
    Else
        LinhaDepoisDaMaiorData = linhaMax + 1
    End If
End Function

'========================
' MACRO PRINCIPAL
'========================
Sub CopiarUltimaLinha_Mensal_Para_Anual()

    Dim wsSrc As Worksheet, wsDst As Worksheet
    Dim srcRow As Long
    Dim dstRow As Long

    Dim oldCalc As XlCalculation
    Dim oldEvents As Boolean
    Dim oldScreen As Boolean

    On Error GoTo EH

    ' Performance
    oldCalc = Application.Calculation
    oldEvents = Application.EnableEvents
    oldScreen = Application.ScreenUpdating

    Application.ScreenUpdating = False
    Application.EnableEvents = False
    Application.Calculation = xlCalculationManual

    ' Abas
    Set wsSrc = ThisWorkbook.Worksheets("Deb, CRICRA FII Fiagro (Mensal)")
    Set wsDst = ThisWorkbook.Worksheets("Deb, CRICRA FII Fiagro (Anual)")

    ' ORIGEM: pega a linha da maior data na coluna B
    srcRow = LinhaDaMaiorData(wsSrc, "B")
    If srcRow = 0 Then Err.Raise 5, , "Não encontrei data válida na origem (coluna B)."

    ' DESTINO: cola depois da maior data na coluna B
    dstRow = LinhaDepoisDaMaiorData(wsDst, "B")

    ' B:P (origem -> destino)
    wsDst.Range("B" & dstRow & ":P" & dstRow).Value = _
        wsSrc.Range("B" & srcRow & ":P" & srcRow).Value

    ' S:U (origem) -> R:T (destino)
    wsDst.Range("R" & dstRow & ":T" & dstRow).Value = _
        wsSrc.Range("S" & srcRow & ":U" & srcRow).Value

    ' Puxar fórmulas U:Z (da linha anterior para a linha destino)
    If dstRow > 1 Then
        wsDst.Range("U" & dstRow & ":Z" & dstRow).FormulaR1C1 = _
            wsDst.Range("U" & (dstRow - 1) & ":Z" & (dstRow - 1)).FormulaR1C1
    End If

    ' AC:AD (origem) -> AB:AC (destino)
    wsDst.Range("AB" & dstRow & ":AC" & dstRow).Value = _
        wsSrc.Range("AC" & srcRow & ":AD" & srcRow).Value

    MsgBox "OK! Colado no Anual logo após a maior data da coluna B.", vbInformation

CleanExit:
    Application.Calculation = oldCalc
    Application.EnableEvents = oldEvents
    Application.ScreenUpdating = oldScreen
    Exit Sub

EH:
    Application.Calculation = oldCalc
    Application.EnableEvents = oldEvents
    Application.ScreenUpdating = oldScreen
    MsgBox "Erro: " & Err.Number & " - " & Err.Description, vbCritical

End Sub
